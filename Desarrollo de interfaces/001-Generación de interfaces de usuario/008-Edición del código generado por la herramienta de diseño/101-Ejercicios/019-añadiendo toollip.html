<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gráfica</title>
    <style>
        .grafica-container {
            display: inline-block;
            margin: 20px;
            text-align: center;
        }
        .grafica {
            position: relative;
            width: 240px;
            aspect-ratio: 1;
            border-radius: 50%;
            cursor: pointer;
        }
        .tooltip {
            position: absolute;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 14px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 1000;
            white-space: nowrap;
        }
        .legend {
            margin-top: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .legend-item {
            display: flex;
            align-items: center;
            margin: 2px 0;
            font-size: 12px;
        }
        .legend-color {
            width: 12px;
            height: 12px;
            margin-right: 5px;
            border-radius: 2px;
        }
        .chart-title {
            font-weight: bold;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <div class="grafica-container">
        <div class="chart-title">Países</div>
        <div class="grafica1 grafica"></div>
        <div class="legend" id="legend1"></div>
    </div>
    <div class="grafica-container">
        <div class="chart-title">Deportes</div>
        <div class="grafica2 grafica"></div>
        <div class="legend" id="legend2"></div>
    </div>
    <div class="grafica-container">
        <div class="chart-title">Colores</div>
        <div class="grafica3 grafica"></div>
        <div class="legend" id="legend3"></div>
    </div>
    <div class="grafica-container">
        <div class="chart-title">Frutas</div>
        <div class="grafica4 grafica"></div>
        <div class="legend" id="legend4"></div>
    </div>

    <script>
        let datos1 = [
            {"Etiqueta":"España", "Valor":56},
            {"Etiqueta":"Francia", "Valor":78},
            {"Etiqueta":"Alemania", "Valor":76},
            {"Etiqueta":"Austria", "Valor":87},
            {"Etiqueta":"Italia", "Valor":98}
        ];
        
        let datos2 = [
            {"Etiqueta": "Fútbol", "Valor": 92},
            {"Etiqueta": "Baloncesto", "Valor": 75},
            {"Etiqueta": "Tenis", "Valor": 63},
            {"Etiqueta": "Natación", "Valor": 58},
            {"Etiqueta": "Ciclismo", "Valor": 71}
        ];
        
        let datos3 = [
            {"Etiqueta": "Rojo", "Valor": 81},
            {"Etiqueta": "Azul", "Valor": 66},
            {"Etiqueta": "Verde", "Valor": 59},
            {"Etiqueta": "Amarillo", "Valor": 72},
            {"Etiqueta": "Morado", "Valor": 48}
        ];
        
        let datos4 = [
            {"Etiqueta": "Manzana", "Valor": 45},
            {"Etiqueta": "Plátano", "Valor": 67},
            {"Etiqueta": "Naranja", "Valor": 52},
            {"Etiqueta": "Uva", "Valor": 78},
            {"Etiqueta": "Fresa", "Valor": 89}
        ];

        function getRandomHexColor(){
            return "#" + Math.floor(Math.random() * 16777215).toString(16).padStart(6, "0");
        }

        function randomLightnessVariation(hex, min = 0.7, max = 1.3) {
            let r = parseInt(hex.slice(1, 3), 16) / 255;
            let g = parseInt(hex.slice(3, 5), 16) / 255;
            let b = parseInt(hex.slice(5, 7), 16) / 255;

            let maxC = Math.max(r, g, b), minC = Math.min(r, g, b);
            let l = (maxC + minC) / 2;
            let s, h;
            
            if (maxC === minC) {
                s = h = 0;
            } else {
                let d = maxC - minC;
                s = l > 0.5 ? d / (2 - maxC - minC) : d / (maxC + minC);
                switch (maxC) {
                    case r: h = (g - b) / d + (g < b ? 6 : 0); break;
                    case g: h = (b - r) / d + 2; break;
                    case b: h = (r - g) / d + 4; break;
                }
                h /= 6;
            }

            let variation = l * (min + Math.random() * (max - min));
            if (variation > 1) variation = 1;
            if (variation < 0) variation = 0;

            function hue2rgb(p, q, t) {
                if (t < 0) t += 1;
                if (t > 1) t -= 1;
                if (t < 1/6) return p + (q - p) * 6 * t;
                if (t < 1/2) return q;
                if (t < 2/3) return p + (q - p) * (2/3 - t) * 6;
                return p;
            }

            let q = variation < 0.5 ? variation * (1 + s) : variation + s - variation * s;
            let p = 2 * variation - q;
            r = hue2rgb(p, q, h + 1/3);
            g = hue2rgb(p, q, h);
            b = hue2rgb(p, q, h - 1/3);

            return "#" + 
                Math.round(r * 255).toString(16).padStart(2, "0") +
                Math.round(g * 255).toString(16).padStart(2, "0") +
                Math.round(b * 255).toString(16).padStart(2, "0");
        }

        function jdgraficatarta(selector, datos, color, legendId) {
            let suma = 0;
            for(let i = 0; i < datos.length; i++) {
                suma += datos[i].Valor;
            }
            
            let cursor = 0;
            let cadena = "";
            let segmentColors = [];
            let segmentData = [];

            for(let i = 0; i < datos.length; i++) {
                let inicio = cursor * 100 + "%";
                cursor += datos[i].Valor / suma;
                let final = cursor * 100 + "%";
                let segmentColor = randomLightnessVariation(color);
                
                cadena += segmentColor + " " + inicio + " " + final + ",";
                segmentColors.push(segmentColor);
                segmentData.push({
                    start: parseFloat(inicio),
                    end: parseFloat(final),
                    label: datos[i].Etiqueta,
                    value: datos[i].Valor,
                    percentage: ((datos[i].Valor / suma) * 100).toFixed(1) + "%",
                    color: segmentColor
                });
            }
            
            cadena = cadena.slice(0, -1);
            let grafica = document.querySelector(selector);
            grafica.style.background = `conic-gradient(${cadena})`;

            // Create tooltip
            let tooltip = document.createElement("div");
            tooltip.className = "tooltip";
            grafica.appendChild(tooltip);

            // Create legend
            let legend = document.getElementById(legendId);
            legend.innerHTML = "";
            
            segmentData.forEach((segment, index) => {
                // Create legend item
                let legendItem = document.createElement("div");
                legendItem.className = "legend-item";
                legendItem.innerHTML = `
                    <div class="legend-color" style="background-color: ${segment.color}"></div>
                    <span>${segment.label}: ${segment.value} (${segment.percentage})</span>
                `;
                legend.appendChild(legendItem);
            });

            // Add mouse move event for tooltip
            grafica.addEventListener("mousemove", function(e) {
                let rect = grafica.getBoundingClientRect();
                let x = e.clientX - rect.left;
                let y = e.clientY - rect.top;
                
                // Convert to polar coordinates
                let centerX = rect.width / 2;
                let centerY = rect.height / 2;
                let deltaX = x - centerX;
                let deltaY = y - centerY;
                let angle = Math.atan2(deltaY, deltaX) * 180 / Math.PI;
                if (angle < 0) angle += 360;
                
                // Find which segment is being hovered
                let hoveredSegment = segmentData.find(segment => {
                    let startAngle = (segment.start / 100) * 360;
                    let endAngle = (segment.end / 100) * 360;
                    return angle >= startAngle && angle <= endAngle;
                });

                if (hoveredSegment) {
                    tooltip.innerHTML = `${hoveredSegment.label}<br>${hoveredSegment.value} (${hoveredSegment.percentage})`;
                    tooltip.style.opacity = "1";
                    tooltip.style.left = (e.clientX - rect.left + 15) + "px";
                    tooltip.style.top = (e.clientY - rect.top - 15) + "px";
                } else {
                    tooltip.style.opacity = "0";
                }
            });

            grafica.addEventListener("mouseleave", function() {
                tooltip.style.opacity = "0";
            });
        }

        // Initialize charts
        jdgraficatarta(".grafica1", datos1, "#008080", "legend1");
        jdgraficatarta(".grafica2", datos2, "#FF0000", "legend2");
        jdgraficatarta(".grafica3", datos3, "#00FF00", "legend3");
        jdgraficatarta(".grafica4", datos4, "#0000ff", "legend4");
    </script>
</body>
</html>